/* 1 –í—ã–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∏–ª—å–º–æ–≤, –≤—ã–ø—É—â–µ–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ
2000-–æ–≥–æ –≥–æ–¥–∞. –í–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å–º—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –æ—Ç 60
–¥–æ 120 –º–∏–Ω—É—Ç (–≤–∫–ª—é—á.). –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 20 —Ñ–∏–ª—å–º–æ–≤ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
(—Å–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ).
 */
SELECT title, description, length
FROM film 
WHERE release_year > 2000 AND length BETWEEN 60 AND 120
ORDER BY length DESC 
LIMIT 20;


/*2. –ù–∞–π—Ç–∏ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏, —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –≤ –∞–ø—Ä–µ–ª–µ 2007-–≥–æ –≥–æ–¥–∞, —á—å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ
–ø—Ä–µ–≤—ã—à–∞–µ—Ç 4 –¥–æ–ª–ª–∞—Ä–æ–≤. –ü–æ–∫–∞–∑–∞—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä, –¥–∞—Ç—É (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏), –∏
—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∞. –ü–ª–∞—Ç–µ–∂–∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏.
–ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –æ—Ç–¥–∞—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–º—É –ø–ª–∞—Ç–µ–∂—É.
*/
SELECT payment_id, DATE(payment_date), amount
FROM payment 
WHERE DATE (payment_date) BETWEEN '2007-04-01' AND '2007-04-30' AND amount <= 4  
ORDER BY amount DESC, payment_date;

/*3. –ü–æ–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–∞, —Ñ–∞–º–∏–ª–∏–∏ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏
‚ÄúJack‚Äù, ‚ÄúBob‚Äù, –∏–ª–∏ ‚ÄúSara‚Äù, —á—å—è —Ñ–∞–º–∏–ª–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—É ‚Äúp‚Äù. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
–∫–æ–ª–æ–Ω–∫—É —Å –∏–º–µ–Ω–µ–º –≤ ‚Äú–ò–º—è‚Äù, —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –≤ ‚Äú–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä‚Äù, —Å
—Ñ–∞–º–∏–ª–∏–µ–π –≤ ‚Äú–§–∞–º–∏–ª–∏—è‚Äù. –ö–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è –∏—Ö
–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞.*/
SELECT first_name AS "–ò–º—è",
	   last_name AS "–§–∞–º–∏–ª–∏—è",
	   customer_id AS "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä"
FROM customer
WHERE first_name IN ('Jack', 'Bob', 'Sara') AND last_name ILIKE '%p%'
ORDER BY customer_id;

/*4. –ü–æ—Å—á–∏—Ç–∞—Ç—å –≤—ã—Ä—É—á–∫—É –≤ –∫–∞–∂–¥–æ–º –º–µ—Å—è—Ü–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–∫–∞—Ç–∞. –ú–µ—Å—è—Ü –¥–æ–ª–∂–µ–Ω
—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø–æ rental_date, –∞ –Ω–µ –ø–æ payment_date. –û–∫—Ä—É–≥–ª–∏—Ç—å –≤—ã—Ä—É—á–∫—É –¥–æ
–æ–¥–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π. –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º
–ø–æ—Ä—è–¥–∫–µ.
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å—Ç—å –º–µ—Å—è—Ü –ø—Ä–æ–∫–∞—Ç–∞, –≥–¥–µ –≤—ã—Ä—É—á–∫–∏ –Ω–µ –±—ã–ª–æ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ
–ø–ª–∞—Ç–µ–∂–∞—Ö) - –æ–Ω –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ—Ç—á–µ—Ç–µ.
*/
SELECT EXTRACT(YEAR FROM rental_date),
	   EXTRACT(MONTH FROM rental_date),
	   ROUND(SUM(p.amount),1)
FROM rental r
LEFT JOIN payment p ON r.rental_id=p.rental_id 
GROUP BY 1,2
ORDER BY 1,2;

/*5. –ù–∞–π—Ç–∏ —Å—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ –∫–∞–∂–¥–æ–º—É –∂–∞–Ω—Ä—É —Ñ–∏–ª—å–º–∞. –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ
–∂–∞–Ω—Ä—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –±–æ–ª–µ–µ 60 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤. –û–∫—Ä—É–≥–ª–∏—Ç—å
—Å—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π. –î–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞–º.
–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∂–∞–Ω—Ä—ã –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.*/
SELECT c.name AS "–ñ–∞–Ω—Ä",
		ROUND(AVG(amount),2) AS "–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂",
FROM film_category fc
LEFT JOIN category c ON fc.category_id=c.category_id
LEFT JOIN film f ON fc.film_id=f.film_id 
LEFT JOIN inventory i ON f.film_id=i.film_id 
LEFT JOIN rental r ON i.inventory_id=r.inventory_id 
LEFT JOIN payment p ON r.rental_id=p.rental_id 
GROUP BY c.category_id
HAVING count(DISTINCT fc.film_id)>60
ORDER BY 2 DESC;


/*6 –ö–∞–∫–∏–µ —Ñ–∏–ª—å–º—ã —á–∞—â–µ –≤—Å–µ–≥–æ –±–µ—Ä—É—Ç –Ω–∞–ø—Ä–æ–∫–∞—Ç –ø–æ —Å—É–±–±–æ—Ç–∞–º? –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è
–ø–µ—Ä–≤—ã—Ö 5 –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å–º–æ–≤. –ï—Å–ª–∏ —É —Ñ–∏–ª—å–º–æ–≤ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è
–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å, –æ—Ç–¥–∞—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–º—É –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É.
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å —Å –ø–æ–º–æ—â—å—é EXTRACT*/
SELECT 	f.title,
    	count(rental_id)
FROM film f
LEFT JOIN inventory i ON f.film_id=i.film_id 
LEFT JOIN rental r ON r.inventory_id=i.inventory_id
WHERE extract(dow from rental_date::timestamp)=6
GROUP BY 1
ORDER BY count(rental_id) DESC, f.title ASC
LIMIT 5;

/*7 –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∏–ª—å–º—ã –≤ —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:–∫–æ—Ä–æ—Ç–∫–∏–µ –º–µ–Ω–µ–µ 70
—Å—Ä–µ–¥–Ω–∏–µ –æ—Ç 70 –¥–æ 130 (–Ω–µ –≤–∫–ª.)
–¥–ª–∏–Ω–Ω—ã–µ 130 –∏ –≤—ã—à–µ
–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∫–∞—Ç–æ–≤ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å–º–æ–≤ –≤ –∫–∞–∂–¥–æ–π —Ç–∞–∫–æ–π
–∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ï—Å–ª–∏ –ø—Ä–æ–∫–∞—Ç–æ–≤ —É —Ñ–∏–ª—å–º–∞ –Ω–µ –±—ã–ª–æ, –Ω–µ –≤–∫–ª—é—á–∞—Ç—å –µ–≥–æ –≤ —Ä–∞—Å—á–µ—Ç—ã
–∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∏–ª—å–º–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø–æ–¥—É–º–∞—Ç—å –Ω–∞–¥ —Ç–∏–ø–æ–º –¥–∂–æ–∏–Ω–∞ üòâ).
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏–ª—å–º–æ–≤ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∫–∞—Ç–æ–≤ –Ω–µ –±—É–¥—É—Ç
–æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —á–∏—Å–ª–∞–º–∏, –≤–µ–¥—å —Ñ–∏–ª—å–º—ã –±–µ—Ä—É—Ç –Ω–∞–ø—Ä–æ–∫–∞—Ç –º–Ω–æ–≥–æ —Ä–∞–∑.
*/
SELECT  CASE 
	      WHEN length < 70 THEN '–∫–æ—Ä–æ—Ç–∫–∏–µ'
	      WHEN length < 130 THEN '—Å—Ä–µ–¥–Ω–∏–µ'
	      WHEN length >=130 THEN '–¥–ª–∏–Ω–Ω—ã–µ'
		END AS "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", 
		count(DISTINCT f.film_id) AS "–ö–æ–ª-–≤–æ —Ñ–∏–ª—å–º–æ–≤",
		count(DISTINCT r.rental_id)AS "–ö–æ–ª-–≤–æ –ø—Ä–æ–∫–∞—Ç–æ–≤"
FROM film f
FULL JOIN inventory i ON f.film_id = i.film_id
INNER JOIN rental r ON i.inventory_id=r.inventory_id
GROUP BY 1
ORDER BY 1;


/* –î–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É weekly_revenue —Å –≤—ã—Ä—É—á–∫–æ–π –ø–æ
–Ω–µ–¥–µ–ª—è–º –∏ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–π:*/
CREATE TABLE weekly_revenue AS 
	SELECT EXTRACT(YEAR FROM rental_date) AS r_year,
		   EXTRACT(week FROM rental_date) AS r_week, 
		   sum(amount) AS revenue 
    FROM rental r 
    LEFT JOIN payment p ON p.rental_id=r.rental_id
    GROUP BY 1,2 
    ORDER BY 1,2;
   
SELECT * 
FROM weekly_revenue; 

/*8. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é —Å—É–º–º—É –Ω–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ –±–∏–∑–Ω–µ—Å–∞.
–í—ã–≤–µ—Å—Ç–∏ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É weekly_revenue —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Å—Ç–æ–ª–±—Ü–æ–º —Å
–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —Å—É–º–º–æ–π.
–û–∫—Ä—É–≥–ª–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –≤—ã—Ä—É—á–∫—É –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞*/
SELECT *, ROUND( SUM(revenue) OVER(ORDER BY r_year, r_week)) AS cum_avarage
FROM weekly_revenue;

/* 9 –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–∫–æ–ª—å–∑—è—â—É—é —Å—Ä–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ –±–∏–∑–Ω–µ—Å–∞.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–¥–µ–ª—é –¥–æ, —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é, –∏ –Ω–µ–¥–µ–ª—é –ø–æ—Å–ª–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
—Å—Ä–µ–¥–Ω–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
–í—ã–≤–µ—Å—Ç–∏ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É weekly_revenue —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å
–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —Å—É–º–º–æ–π –∏ —Å–∫–æ–ª—å–∑—è—â–µ–π —Å—Ä–µ–¥–Ω–µ–π.
–û–∫—Ä—É–≥–ª–∏—Ç—å —Å–∫–æ–ª—å–∑—è—â—É—é —Å—Ä–µ–¥–Ω—é—é –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞.
*/
SELECT *, 
	 ROUND( SUM(revenue) OVER(ORDER BY r_year, r_week)) AS cum_avarage,
	 ROUND( AVG (revenue) OVER (ORDER BY  r_year, r_week 
	 							ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING)) AS mov_avarage
FROM weekly_revenue;

/*10.–ü–æ—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –Ω–µ–¥–µ–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ –±–∏–∑–Ω–µ—Å–∞ –≤ %.
–ü—Ä–∏—Ä–æ—Å—Ç –≤ % =
–¢–µ–∫—É—â–∞—è –≤—ã—Ä—É—á–∫–∞ ‚àí –ü—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∞—è –≤—ã—Ä—É—á–∫–∞
–ü—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∞—è –≤—ã—Ä—É—á–∫–∞
* 100%
–í—ã–≤–µ—Å—Ç–∏ –≤—Å—é —Ç–∞–±–ª–∏—Ü—É weekly_revenue —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å—Ç–æ–ª–±—Ü–∞–º–∏ —Å
–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —Å—É–º–º–æ–π, —Å–∫–æ–ª—å–∑—è—â–µ–π —Å—Ä–µ–¥–Ω–µ–π –∏ –ø—Ä–∏—Ä–æ—Å—Ç–æ–º.
–û–∫—Ä—É–≥–ª–∏—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.
*/

SELECT *,
	 ROUND( SUM(revenue) OVER(ORDER BY r_year, r_week
	 						  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)) AS cum_avarage,
	 ROUND( AVG (revenue) OVER (ORDER BY r_year, r_week 
	 							ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING)) AS mov_avarage,
	ROUND((revenue-lag(revenue, 1) OVER my_window)*100.00/lag(revenue, 1) OVER
my_window, 2) AS pct_growth
FROM weekly_revenue
WINDOW my_window AS (
ORDER BY r_year, r_week ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW);
